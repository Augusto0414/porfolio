---
import ProjectCard from './ProjectCard.astro';
import { projects } from '../data/projects';
---

<div>
  <div class="mb-8">
    <h2 class="text-3xl sm:text-4xl font-bold text-white mb-2">Proyectos</h2>
    <p class="text-base text-gray-500">Aplicaciones que he desarrollado</p>
  </div>
  
  <!-- Modal Lightbox para Imágenes -->
  <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
    <div class="lightbox-inner relative w-full max-w-[95vw] max-h-[95vh] flex items-center justify-center p-4">
      <button id="closeLightbox" class="close-btn absolute top-3 right-3 z-20" aria-label="Cerrar">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <img id="lightboxImage" src="" alt="" class="lightbox-image max-w-full max-h-full object-contain rounded-lg shadow-xl" />
    </div>
  </div>

  <!-- Modal Lightbox para Videos -->
  <div id="videoLightbox" class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4">
    <button id="closeVideoLightbox" class="close-btn fixed top-4 right-4 z-[9999]" aria-label="Cerrar video">
      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <div class="lightbox-inner relative w-full max-w-[95vw] max-h-[95vh] flex items-center justify-center p-4">
        <video id="lightboxVideo" class="lightbox-video w-full h-full max-w-full max-h-full object-contain rounded-lg shadow-xl" controls playsinline loop>
          <source id="lightboxVideoSourceWebm" src="" type="video/webm" />
          <source id="lightboxVideoSourceMp4" src="" type="video/mp4" />
      </video>
      <div id="lightboxVideoError" class="hidden absolute inset-0 flex items-center justify-center text-center p-6">
        <div class="bg-black/80 text-white rounded-md p-4 max-w-[90%]">
          <p class="mb-2">No se puede reproducir este video en tu navegador.</p>
          <a id="lightboxVideoDownload" class="underline text-sm" href="#" target="_blank" rel="noreferrer">Descargar video</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {projects.map((project) => <ProjectCard project={project} />)}
  </div>
</div>

<style>
  .carousel-container {
    position: relative;
    overflow: hidden;
  }

  .carousel-image {
    transition: transform 0.3s ease;
  }

  .dot.active {
    background-color: white;
    transform: scale(1.2);
  }

  .video-overlay {
    opacity: 1;
    pointer-events: all;
    z-index: 5;
    cursor: pointer;
  }

  .digiturno-video.playing ~ .video-overlay {
    opacity: 0;
    pointer-events: none;
  }

  /* Lightbox styles */
  .lightbox-inner {
    backdrop-filter: blur(6px);
    border-radius: 12px;
    overflow: hidden;
    animation: fadeInScale .18s ease-out both;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    border-radius: 8px;
    max-width: 100%;
    max-height: calc(95vh - 3rem);
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
    margin: 0 auto;
  }

  .lightbox-video {
    background: #000;
    border-radius: 8px;
  }

  /* Carousel / card images: always fit and remain visible */
  .carousel-image {
    width: 100%;
    height: auto;
    max-height: 60vh;
    object-fit: contain;
    display: block;
  }

  .close-btn {
    background: rgba(0,0,0,0.5);
    padding: 6px;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    transition: background .15s ease, transform .08s ease;
  }

  .close-btn:focus,
  .close-btn:hover {
    background: rgba(255,255,255,0.06);
    transform: scale(1.02);
    outline: none;
  }

  @keyframes fadeInScale {
    from { opacity: 0; transform: scale(.985); }
    to   { opacity: 1; transform: scale(1); }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('.carousel-container');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage') as HTMLImageElement;
    const closeLightbox = document.getElementById('closeLightbox');
    
    const videoLightbox = document.getElementById('videoLightbox');
    const lightboxVideo = document.getElementById('lightboxVideo') as HTMLVideoElement;
    const srcWebmEl = document.getElementById('lightboxVideoSourceWebm') as HTMLSourceElement;
    const srcMp4El = document.getElementById('lightboxVideoSourceMp4') as HTMLSourceElement;
    const closeVideoLightbox = document.getElementById('closeVideoLightbox');

    // Helper para comprobar existencia de recursos vía HEAD (reutilizable)
    async function exists(url: string): Promise<boolean> {
      try {
        const r = await fetch(url, { method: 'HEAD' });
        return r.ok;
      } catch (e) {
        return false;
      }
    }
    
    // Asegurar que los modales estén en el <body> para cubrir toda la página
    if (lightbox && lightbox.parentElement !== document.body) document.body.appendChild(lightbox);
    if (videoLightbox && videoLightbox.parentElement !== document.body) document.body.appendChild(videoLightbox);

    // Funcionalidad del Lightbox (solo para imágenes, no para videos)
    const allImageContainers = document.querySelectorAll('.carousel-track > div');
    allImageContainers.forEach(container => {
      // Solo activar lightbox si el contenedor tiene una imagen, no un video
      const hasVideo = container.querySelector('.digiturno-video');
      if (hasVideo) return; // Saltar si es un contenedor de video
      
      // Añadir click a todo el contenedor y al overlay
      const clickHandler = (e: Event) => {
        e.stopPropagation();
        const img = container.querySelector('.carousel-image') as HTMLImageElement;
        if (img && lightbox && lightboxImage) {
          lightboxImage.src = img.src;
          lightboxImage.alt = img.alt;
          if (lightbox.parentElement !== document.body) document.body.appendChild(lightbox);
          lightbox.classList.remove('hidden');
          lightbox.classList.add('flex');
          document.body.classList.add('overflow-hidden');
        }
      };
      
      container.addEventListener('click', clickHandler);
      
      // También añadir al overlay específicamente
      const overlay = container.querySelector('.absolute.inset-0');
      if (overlay) {
        overlay.addEventListener('click', clickHandler);
      }
    });

    // Cerrar lightbox con botón X
    if (closeLightbox) {
      closeLightbox.addEventListener('click', () => {
        if (lightbox) {
          lightbox.classList.add('hidden');
          lightbox.classList.remove('flex');
          document.body.classList.remove('overflow-hidden');
        }
      });
    }

    // Cerrar lightbox haciendo click fuera de la imagen
    if (lightbox) {
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          lightbox.classList.add('hidden');
          lightbox.classList.remove('flex');
          document.body.classList.remove('overflow-hidden');
        }
      });
    }

    // Cerrar con tecla ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (lightbox && !lightbox.classList.contains('hidden')) {
          lightbox.classList.add('hidden');
          lightbox.classList.remove('flex');
          document.body.classList.remove('overflow-hidden');
        }
        if (videoLightbox && !videoLightbox.classList.contains('hidden')) {
          videoLightbox.classList.add('hidden');
          videoLightbox.classList.remove('flex');
          if (lightboxVideo) {
            lightboxVideo.pause();
            // limpiar todos los <source> al cerrar desde ESC
            lightboxVideo.querySelectorAll('source').forEach(s => (s as HTMLSourceElement).setAttribute('src', ''));
            lightboxVideo.load();
            document.body.classList.remove('overflow-hidden');
          }
        }
      }
    });

    // Cerrar video lightbox con botón X
    if (closeVideoLightbox) {
      closeVideoLightbox.addEventListener('click', () => {
        if (videoLightbox) {
          videoLightbox.classList.add('hidden');
          videoLightbox.classList.remove('flex');
          if (lightboxVideo) {
            lightboxVideo.pause();
            // limpiar todos los <source> para liberar memoria y permitir recarga
            lightboxVideo.querySelectorAll('source').forEach(s => (s as HTMLSourceElement).setAttribute('src', ''));
            lightboxVideo.load();
            document.body.classList.remove('overflow-hidden');
          }
        }
      });
    }

    // Cerrar video lightbox haciendo click fuera del video
    if (videoLightbox) {
      videoLightbox.addEventListener('click', (e) => {
        if (e.target === videoLightbox) {
          videoLightbox.classList.add('hidden');
          videoLightbox.classList.remove('flex');
          if (lightboxVideo) {
            lightboxVideo.pause();
            lightboxVideo.querySelectorAll('source').forEach(s => (s as HTMLSourceElement).setAttribute('src', ''));
            lightboxVideo.load();
            document.body.classList.remove('overflow-hidden');
          }
        }
      });
    }

    // Botones de ampliar video
    const expandButtons = document.querySelectorAll('.expand-video');
    expandButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        e.stopPropagation();
        const container = (button as HTMLElement).closest('.group\/video');
        if (!container) return;

        const video = container.querySelector('.digiturno-video') as HTMLVideoElement;
        if (!video) return;

        const videoSrc = video.getAttribute('data-video-src');
        if (!videoSrc || !videoLightbox || !lightboxVideo) return;

        // Derivar rutas esperadas
        const encoded = encodeURI(videoSrc);
        const urlObj = new URL(encoded, location.origin);
        const dirname = urlObj.pathname.substring(0, urlObj.pathname.lastIndexOf('/'));
        const filename = urlObj.pathname.substring(urlObj.pathname.lastIndexOf('/') + 1);
        const base = filename.replace(/\.mp4$/i, '');
        const webmPath = `${dirname}/${base}.webm`;
        const h264Path = `${dirname}/${base}-h264.mp4`;

        const srcWebmEl = document.getElementById('lightboxVideoSourceWebm') as HTMLSourceElement;
        const srcMp4El = document.getElementById('lightboxVideoSourceMp4') as HTMLSourceElement;

        const originBase = location.origin;
        let chosenWebm = null;
        let chosenMp4 = null;

        if (await exists(webmPath)) chosenWebm = webmPath;
        if (await exists(h264Path)) chosenMp4 = h264Path;
        // if neither transcode exists, fallback to original MP4
        if (!chosenMp4 && await exists(encoded)) chosenMp4 = encoded;

        if (srcWebmEl) srcWebmEl.src = chosenWebm || '';
        if (srcMp4El) srcMp4El.src = chosenMp4 || '';

        lightboxVideo.load();
        videoLightbox.classList.remove('hidden');
        videoLightbox.classList.add('flex');
        if (closeVideoLightbox) closeVideoLightbox.focus();

        // intentar play iniciando muteado para evitar bloqueo del navegador
        lightboxVideo.muted = true;
        lightboxVideo.play().then(() => {
          setTimeout(() => { try { lightboxVideo.muted = false; } catch(e){} }, 150);
        }).catch(err => {
          console.error('Error reproducir video en lightbox:', err);
        });
      });
    });

        // Manejo de errores en el reproductor del lightbox
        const lightboxVideoError = document.getElementById('lightboxVideoError');
        const lightboxVideoDownload = document.getElementById('lightboxVideoDownload');
        if (lightboxVideo) {
          lightboxVideo.addEventListener('error', (ev) => {
            console.error('Error en lightboxVideo:', ev, lightboxVideo.currentSrc);
            if (lightboxVideoError) {
              lightboxVideoError.classList.remove('hidden');
              lightboxVideoError.classList.add('flex');
            }
            if (lightboxVideoDownload && lightboxVideo.currentSrc) {
              (lightboxVideoDownload as HTMLAnchorElement).href = lightboxVideo.currentSrc;
            }
          });

          lightboxVideo.addEventListener('loadeddata', () => {
            if (lightboxVideoError) {
              lightboxVideoError.classList.add('hidden');
              lightboxVideoError.classList.remove('flex');
            }
          });
        }
    
    // Funcionalidad del Carrusel
    carousels.forEach(carousel => {
      const track = carousel.querySelector('.carousel-track') as HTMLElement;
      const slides = carousel.querySelectorAll('.carousel-track > div');
      const prevBtn = carousel.querySelector('.prev') as HTMLButtonElement;
      const nextBtn = carousel.querySelector('.next') as HTMLButtonElement;
      const dots = carousel.querySelectorAll('.dot');
      
      if (!track || !prevBtn || !nextBtn || slides.length === 0) return;
      
      let currentIndex = 0;
      const totalSlides = slides.length;
      
      function pauseAllVideos() {
        const allVideos = carousel.querySelectorAll('.digiturno-video') as NodeListOf<HTMLVideoElement>;
        allVideos.forEach(video => {
          if (!video.paused) {
            video.pause();
            video.classList.remove('playing');
          }
        });
      }
      
      function updateCarousel() {
        if (track) {
          pauseAllVideos(); // Pausar todos los videos al cambiar de slide
          track.style.transform = `translateX(-${currentIndex * 100}%)`;
        }
        dots.forEach((dot, index) => {
          dot.classList.toggle('active', index === currentIndex);
        });
      }
      
      prevBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
        updateCarousel();
      });
      
      nextBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex + 1) % totalSlides;
        updateCarousel();
      });
      
      dots.forEach((dot, index) => {
        dot.addEventListener('click', (e) => {
          e.stopPropagation();
          currentIndex = index;
          updateCarousel();
        });
      });
    });

    // Funcionalidad del Video - usando delegación de eventos más robusta
    const videoContainers = document.querySelectorAll('.group\\/video');
    
    videoContainers.forEach(container => {
      const video = container.querySelector('.digiturno-video') as HTMLVideoElement;
      const overlay = container.querySelector('.video-overlay') as HTMLElement;
      
      if (!video || !overlay) {
        console.log('Video o overlay no encontrado');
        return;
      }

      console.log('Video configurado:', video.dataset.videoSrc);

      // Click en el overlay: abrir el lightbox de video (mejor experiencia)
      overlay.addEventListener('click', async (e) => {
        e.stopPropagation();
        e.preventDefault();

        const videoSrc = video.dataset.videoSrc;
        if (!videoSrc || !videoLightbox || !lightboxVideo || (!srcWebmEl && !srcMp4El)) return;

        // Pause cualquier video en el card
        try {
          const siblingVideos = document.querySelectorAll('.digiturno-video');
          siblingVideos.forEach(v => { try { (v as HTMLVideoElement).pause(); } catch{} });
        } catch {}

        // Usar URL codificada para evitar problemas con espacios
        const encoded = encodeURI(videoSrc);
        const urlObj = new URL(encoded, location.origin);
        const dirname = urlObj.pathname.substring(0, urlObj.pathname.lastIndexOf('/'));
        const filename = urlObj.pathname.substring(urlObj.pathname.lastIndexOf('/') + 1);
        const base = filename.replace(/\.mp4$/i, '');
        const webmPath = `${dirname}/${base}.webm`;
        const h264Path = `${dirname}/${base}-h264.mp4`;

        let chosenWebm = null;
        let chosenMp4 = null;

        if (await exists(webmPath)) chosenWebm = webmPath;
        if (await exists(h264Path)) chosenMp4 = h264Path;
        if (!chosenMp4 && await exists(encoded)) chosenMp4 = encoded;

        if (srcWebmEl) srcWebmEl.src = chosenWebm || '';
        if (srcMp4El) srcMp4El.src = chosenMp4 || '';

        lightboxVideo.load();

        videoLightbox.classList.remove('hidden');
        videoLightbox.classList.add('flex');
        if (closeVideoLightbox) closeVideoLightbox.focus();

        // Reproducir en el modal iniciando muteado para evitar bloqueo del navegador
        lightboxVideo.muted = true;
        lightboxVideo.play().then(() => {
          setTimeout(() => { try { lightboxVideo.muted = false; } catch(e){} }, 150);
        }).catch(err => {
          console.error('Error reproducir video en lightbox:', err);
        });
      });

      // Click en el video para pausar
      video.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!video.paused) {
          video.pause();
        }
      });

      // Mostrar overlay cuando el video termina o se pausa
      video.addEventListener('pause', () => {
        video.classList.remove('playing');
        overlay.style.opacity = '1';
        overlay.style.pointerEvents = 'all';
      });

      video.addEventListener('ended', () => {
        video.classList.remove('playing');
        overlay.style.opacity = '1';
        overlay.style.pointerEvents = 'all';
        video.currentTime = 0;
      });
      
      // Evento de error de carga
      video.addEventListener('error', (e) => {
        console.error('Error cargando video:', video.src, e);
        overlay.style.opacity = '1';
        overlay.style.pointerEvents = 'all';
        video.classList.remove('playing');
      });
    });
  });
</script>
